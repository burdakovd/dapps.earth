DOCKER_COMPOSE_VERSION: 1.22.0

env:
  global:
    # TRAVIS_PASSWORD_f697c9a46053e55a (to deploy .env.staging)
    - secure: "G/aeJ4qDbx3wysNI3QeyjRZT9c5mhNhwJ2ae91fFWHndyMReORLOuU4MJiFnqrLiHl79JLTmBzEzbbAjeqs/hmZl91lQTqiJZZ0I+osi4HGN2OYkOovsdcW3CF1aJ87AP64UGCaRUSmchNqpRmUbsENmIdV43UE9keshP1LVpyAXgFGyoIK/zJQm75QYrjmVqhPNC9unHOfKzo/dUBe43WBFv+Qs8Dop4a/QxodQxhw2l4/S04D5Xu7D6SumUvZTC31Ba17l/k74aZGVq/+y66rcGtbVSbHsZO7kDbMi+5zCa1PUo8HnSmkzm1aJZebUPxwYbp6N4ALFtNtGy2PIDJD4zieWaYHLriCOU8JFQYRE6m63ha6OrdV8TDmo5eZaIQzZAdvXnvOxPKEGqsikDJp/pSlcemxu4PMEovYYfPtMet2RDSRsaHwEkxBPtJN06Oa0vih6HhKRQVO6MOss/MKziHO57PpAC8N/mNtVCXjTs78to5cgHnbKvGSAgSaCDyLCnMRmntE8+IEhqnK6lDEC5DzA3My4/WgTfJ+vxUo/TMEETxwH5DDf62YSYrhNWvCqdaLNXjc8xTht4uibLI1GcE/s6zj4VgygJI4iZzur1Z394qWrIM8V+84E1NWuvGlbxrIFAZ0M9Vsn9gu8L/SQahYGA0TIohI9IIL4j8g="
    # TRAVIS_PASSWORD_0fdd06da3f1beacf (to deploy .env)
    - secure: "S/Adtt/3AIU9B8dQWsRxxN4+VB7yQn0Io9JUm/57AeKuzjePThsqByuK/UxGB27JNycnShoSszoLsofev+QSAeGGdTdDJ+6aZL1Ozr/MvPJbfM8+uyZc8KMWhPzQ+inuhfQ8UjUb6EpyClhPLKDuINMhrawNrSB7Bextq8EAJddclSsMUj73DBJStDI84YWemfTwRvy/cZWZqDH7x2l0J0kxhBLIaJEJ4C0r3u/t3wmrZ33CqZhIiFaoI8KEK4NtGwnJMkGyuW224hsFC9V3yMXL+PUyV8NVDF7KtQGPr3GdBjkpn8Stsx3hFdtXzT8N4UwGMAzDYA97QActIKunKZFqNEhvX8hszzpznGOhNwUuhjwQu1BbmnuQBl9BS6/k+E3KyDS85xQ8NfmkLclIZ71qSu2JFr9qqsjeAw0UZQ3aAeqsDo7nd2LcPZudNo6wBclyd2pHREGz493x4BCblRsVoKbrV8mMfmDWSC7r3+9o9MkeMPQHtAeEX3/JxanMHuPJe7HyKWZhMzoqWyZQUfgAoRhHDepcLWJ73JFV07FuW2HPtWnQ9qhqdaZDMa2QszbCt/cqIgKB+2chec7d5Fv1BYJFlMb9PbGwdwsbZJ1ZwFxG6KYDsXTb3dJsG4XYI+feel50VRjH2ULwo7Pyzw9tYrJ5MdnZ6KD427iQULI="

before_install:
  - sudo apt-get install jq dnsutils

script:
  - docker-compose pull
  - docker-compose build
  - (cd websites/audit && docker build -f Dockerfile.cli -t audit-cli .)
  - docker run -e JUST_PRINT_AUDIT_PAGE=1 dappsearth_frontend > audit.html.expected
  - diff audit.html audit.html.expected
  - rm -f audit.html.expected
  - if docker run audit-cli staging.dapps.earth; then echo "This should not have succeeded" && false; else echo "failed as planned"; fi
  - docker run audit-cli dapps.earth

after_success:
  - if [ "$TRAVIS_BRANCH" == "master" ]; then
      docker login -u="$DOCKER_AUDIT_PUSH_USER" -p="$DOCKER_AUDIT_PUSH_PASSWORD";
      docker tag audit-cli dappsearth/audit;
      docker push dappsearth/audit;
    fi
  - ./scripts/travis-deploy.sh .env.staging
  - ./scripts/travis-deploy.sh .env
