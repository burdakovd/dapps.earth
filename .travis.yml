DOCKER_COMPOSE_VERSION: 1.22.0

env:
  global:
    # TRAVIS_PASSWORD_f697c9a46053e55a (to deploy .env.staging)
    - secure: "G/aeJ4qDbx3wysNI3QeyjRZT9c5mhNhwJ2ae91fFWHndyMReORLOuU4MJiFnqrLiHl79JLTmBzEzbbAjeqs/hmZl91lQTqiJZZ0I+osi4HGN2OYkOovsdcW3CF1aJ87AP64UGCaRUSmchNqpRmUbsENmIdV43UE9keshP1LVpyAXgFGyoIK/zJQm75QYrjmVqhPNC9unHOfKzo/dUBe43WBFv+Qs8Dop4a/QxodQxhw2l4/S04D5Xu7D6SumUvZTC31Ba17l/k74aZGVq/+y66rcGtbVSbHsZO7kDbMi+5zCa1PUo8HnSmkzm1aJZebUPxwYbp6N4ALFtNtGy2PIDJD4zieWaYHLriCOU8JFQYRE6m63ha6OrdV8TDmo5eZaIQzZAdvXnvOxPKEGqsikDJp/pSlcemxu4PMEovYYfPtMet2RDSRsaHwEkxBPtJN06Oa0vih6HhKRQVO6MOss/MKziHO57PpAC8N/mNtVCXjTs78to5cgHnbKvGSAgSaCDyLCnMRmntE8+IEhqnK6lDEC5DzA3My4/WgTfJ+vxUo/TMEETxwH5DDf62YSYrhNWvCqdaLNXjc8xTht4uibLI1GcE/s6zj4VgygJI4iZzur1Z394qWrIM8V+84E1NWuvGlbxrIFAZ0M9Vsn9gu8L/SQahYGA0TIohI9IIL4j8g="
    # TRAVIS_PASSWORD_6998d03f8b7f08a4 (to deploy .env)
    - secure: "bNF+HjCB1Xz8vF4K1v8RTA26KD3rDvGg7NaCR1z0O+w1PRyjOgedQbWyAM1+t+IRZ9rVqIsQ6CavSae88x5rPKHE1IKjrgBrOi1mpYYm+9XumLPRaVxwE9RaaQGtjkPwk3mo/UW+4RppkXpUyr0kcSSf5W21keTe8ryEb5gghL6pfvHaL6WB1/tfBap/Ih0PvWF3kbI/zi8xYNiGBm3EkzPpCYawvjnJwlLBBx0ZZPSd3LJSe3lT0vx3uML78e1svCUDdClue6iF25kMfufNxpWaomKfevMNBW2MBN9poBt9eNXVRp3FadAEep4emgEs/BGRa849Fh4ZG3vO7K8op3EZ4/s3ej57iFsw5q8FdVaE0o60Go2hwHqxybaU5zTgmSaDkEn8kbptzATszCWcLXms+57uY7n6KPKvaG9tAc0hbHRm7brWlLSB5qkCkvSdoQbzriZwT3GbhhLa7VpexQp/uQf+bHu/2vU10SPFHcX/6VLUVb4XFbNC/CiwV72kdFp6BtHCSMCeiQ9sKyEHd0iROy1MzTKUT++KcY3PShSkXl2IeF0Y3i2FqhJw+A67g2o2ga4uYn8L7c1XJlSnFkziPHL4lWsYC79zkWA2HZIF09h60RF7PPoAagglNQNQCDyfE57s9zd+Qt/pl+a5NoQb71bTQYPDgCuOsZf3O6M="

before_install:
  - sudo apt-get install jq dnsutils

script:
  - docker-compose pull
  - docker-compose build
  - (cd websites/audit && docker build -f Dockerfile.cli -t audit-cli .)
  - docker run -e JUST_PRINT_AUDIT_PAGE=1 dappsearth_frontend > audit.html.expected
  - diff audit.html audit.html.expected
  - rm -f audit.html.expected
  - if docker run audit-cli staging.dapps.earth; then echo "This should not have succeeded" && false; else echo "failed as planned"; fi
  - docker run audit-cli dapps.earth

after_success:
  - if [ "$TRAVIS_BRANCH" == "master" ]; then
      docker login -u="$DOCKER_AUDIT_PUSH_USER" -p="$DOCKER_AUDIT_PUSH_PASSWORD";
      docker tag audit-cli dappsearth/audit;
      docker push dappsearth/audit;
    fi
  - ./scripts/travis-deploy.sh .env.staging
  - ./scripts/travis-deploy.sh .env
